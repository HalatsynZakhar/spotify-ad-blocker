# Инструкции по тестированию исправленного блокировщика рекламы Spotify

## Исправления в этой версии

### ✅ Исправлена функция `_check_track_duration`
- Улучшено определение рекламы по паттернам в заголовке
- Добавлена проверка структуры "Артист - Трек"
- Более точное распознавание рекламных призывов

### ✅ Исправлена проблема с PowerShell
- Добавлено отслеживание переключений окон
- Блокировщик не срабатывает при активации PowerShell/CMD
- Добавлена 2-секундная защита после переключения окон

### ✅ Улучшена общая логика определения рекламы
- Более строгие критерии срабатывания
- Требуется больше подтверждений для активации
- Добавлена проверка, что Spotify действительно запущен

## Быстрый тест

1. **Установите зависимости**:
   ```bash
   pip install -r requirements.txt
   ```

2. **Запустите блокировщик**:
   ```bash
   python spotify_ad_blocker.py
   ```

3. **Откройте Spotify** и включите музыку

4. **Проверьте логи** - должны появиться сообщения о мониторинге

## Проверка улучшений

### ✅ Тест на ложные срабатывания

#### Тест 1: Проверка исправления проблемы с PowerShell ⭐ НОВЫЙ
1. Запустите блокировщик
2. Откройте Spotify и включите музыку
3. Откройте PowerShell или Command Prompt
4. Переключайтесь между Spotify и PowerShell несколько раз
5. **Ожидаемый результат:** Звук НЕ должен отключаться при активации PowerShell
6. **Проверьте логи:** Должно появиться сообщение о переключении окон

#### Тест 2: Переключение между треками
1. Включите обычную музыку в Spotify
2. Переключайтесь между треками
3. **Ожидаемый результат**: звук НЕ должен отключаться
4. **Проверьте логи**: не должно быть сообщений "Реклама обнаружена"

### ✅ Тест определения рекламы

1. Дождитесь рекламы в Spotify Free
2. **Ожидаемый результат**: звук должен отключиться через 1-2 секунды
3. **Проверьте логи**: должно появиться "Реклама обнаружена после 3 проверок"
4. После рекламы звук должен автоматически включиться

### ✅ Тест точного управления звуком

1. Во время работы блокировщика откройте другое аудио (YouTube, браузер)
2. **Ожидаемый результат**: звук других приложений НЕ должен отключаться
3. Только Spotify должен отключаться при рекламе

## Мониторинг работы

### Логи в консоли
```
[2024-01-01 12:00:00] [INFO] Начат мониторинг Spotify
[2024-01-01 12:00:01] [INFO] Spotify запущен
[2024-01-01 12:00:30] [INFO] Реклама обнаружена: окно=True, аудио=False, процесс=True, длительность=True, фокус=False
[2024-01-01 12:00:32] [INFO] Реклама обнаружена после 3 проверок
[2024-01-01 12:00:32] [INFO] Spotify отключен (реклама обнаружена)
[2024-01-01 12:00:45] [INFO] Музыка обнаружена после 3 проверок
[2024-01-01 12:00:45] [INFO] Spotify включен
```

### Файл логов
Логи также сохраняются в: `%USERPROFILE%\.spotify_ad_blocker\ad_blocker.log`

## Устранение проблем

### Если блокировщик не работает:

1. **Проверьте зависимости**:
   ```bash
   pip install pycaw pywin32 psutil requests
   ```

2. **Запустите от имени пользователя** (НЕ администратора)

3. **Убедитесь, что Spotify запущен**

### Если много ложных срабатываний:

1. Проверьте логи на детали определения
2. Возможно, нужно настроить пороги в коде
3. Убедитесь, что используется последняя версия

### Если звук не отключается при рекламе:

1. Проверьте, установлен ли `pycaw`
2. Убедитесь, что Spotify запущен как обычное приложение
3. Проверьте логи на ошибки

## Ожидаемые улучшения

✅ **Значительно меньше ложных срабатываний** (требуется 3 подтверждения)
✅ **Точное отключение только Spotify** (не всей системы)
✅ **Быстрое реагирование** (проверка каждые 0.5 сек)
✅ **Множественные методы определения** (5 различных проверок)
✅ **Детальное логирование** для отладки

## Сравнение с предыдущей версией

| Параметр | Старая версия | Новая версия |
|----------|---------------|---------------|
| Ложные срабатывания | Часто | Редко (требуется 3 подтверждения) |
| Точность определения | 1 метод | 5 методов |
| Управление звуком | Вся система | Только Spotify |
| Скорость реакции | 1 сек | 0.5 сек |
| Логирование | Минимальное | Подробное |

---

**Примечание**: Для полной функциональности требуется Spotify Free (с рекламой) для тестирования.